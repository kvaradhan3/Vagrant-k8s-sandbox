#! /bin/sh
#
# some basic tools
#
data=/vagrant/data
centos_hosts=
debian_hosts=
for i in $(do-on) ; do
    ID_LIKE=$(do-on $i cat /etc/os-release | egrep ^ID_LIKE= | tr 'A-Z' 'a-z')
    case $ID_LIKE in
    *debian*)   debian_hosts="$debian_hosts $i" ;;
    *rhel*)     centos_hosts="$centos_hosts $i" ;;
    esac
done

on_centos() {
    do-on "$centos_hosts" "$@"
}
on_debian() {
    do-on "$debian_hosts" "$@"
}

COMMON_TOOLS="git traceroute lsof"
CENTOS_TOOLS="epel-release yum-utils kernel-devel kernel-headers \
              device-mapper-persistent-data lvm2"
DEBIAN_TOOLS="apt-transport-https linux-headers-generic"

CENTOS_DOCKER_REPO=https://download.docker.com/linux/centos/docker-ce.repo
DEBIAN_KUBE_REPO=

do-on "$centos_hosts" yum install -y $COMMON_TOOLS $CENTOS_TOOLS
do-on "$debian_hosts" apt install -y $COMMON_TOOLS $DEBIAN_TOOLS

#
# docker
#
do-on all mkdir /etc/docker
do-on all cp $data/docker/daemon.json /etc/docker/daemon.json

do-on "$centos_hosts" yum-config-manager --add-repo $CENTOS_DOCKER_REPO
do-on "$centos_hosts" yum install -y docker-ce containerd.io

do-on "$debian_hosts" apt install -y docker.io
do-on all systemctl start docker
do-on all systemctl enable docker

#
# k8s repos
#
#DEBIAN_K8S_REPO="http://apt.kubernetes.io/ kubernetes-xenial main"
DEBIAN_K8S_REPO="http://packages.cloud.google.com/apt/ kubernetes-xenial main"

do-on "$centos_hosts" cp $data/yum.repos.d/kubernetes.repo /etc/yum.repos.d/kubernetes.repo
do-on "$debian_hosts" curl https://packages.cloud.google.com/apt/doc/apt-key.gpg --output /tmp/apt-key.gpg
do-on "$debian_hosts" apt-key add /tmp/apt-key.gpg
do-on "$debian_hosts" apt-add-repository "\"deb $DEBIAN_K8S_REPO\""
#do-on "$debian_hosts" cp $data/apt/apt.conf /etc/apt/apt.conf
do-on "$debian_hosts" apt-get update


#
# kubernetes prep work
#
# disable SElinux on centos
#
do-on "$centos_hosts" setenforce 0
do-on "$centos_hosts" sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config

#
# no swap
#
do-on all swapoff -a
do-on all sed -i '/swap/s/^/#/' /etc/fstab

do-on all cp $data/sysctl.d/k8s.conf /etc/sysctl.d/k8s.conf
do-on all sysctl --system

do-on "$centos_hosts" yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
do-on "$debian_hosts" apt install -y kubelet kubeadm kubectl
do-on "$debian_hosts" apt-mark hold  kubelet kubeadm kubectl
do-on all systemctl enable --now kubelet

#
# bring up to date
#
do-on "$centos_hosts" yum update  -y
do-on "$debian_hosts" apt upgrade -y
do-on "$debian_hosts" apt autoremove -y
vagrant reload
